AWSTemplateFormatVersion: 2010-09-09

Description: S3 bucket - lab-check

Resources:
  S3Bucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: "kemper-s3-lab-check-s1"
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      Tags:
        - Key: Account
          Value: lab
        - Key: ProductCode
          Value: P123
        - Key: AppOwner
          Value: nperala@kemper.com
        - Key: AppEnv
          Value: s1
    DeletionPolicy: Retain
  BucketPolicy:
    Type: 'AWS::S3::BucketPolicy'
    Properties:
      Bucket: kemper-s3-lab-check-s1
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Sid: Require SSL to access bucket
            Effect: Deny
            Principal: "*"
            Action: s3:*
            Resource: 'arn:aws:s3:::kemper-s3-lab-check-s1/*'
            Condition:
              Bool:
                aws:SecureTransport: 'false'
          - Sid: Allow Jenkins Read Access
            Effect: Allow
            Principal:
              AWS: 
                - !Join ['',['arn:aws:iam::', !Ref 'AWS::AccountId' ,':role/role-readonly-s3-lab-check-s1']]
            Action: 
              - 's3:ListBucket'
              - 's3:GetObject'
            Resource:
              - 'arn:aws:s3:::kemper-s3-lab-check-s1'
              - 'arn:aws:s3:::kemper-s3-lab-check-s1/*'          
          - Sid: Allow Jenkins Read-Write Access
            Effect: Allow
            Principal:
              AWS: 
                - !Join ['',['arn:aws:iam::', !Ref 'AWS::AccountId' ,':user/jenkinsbuild']]
                - !Join ['',['arn:aws:iam::', !Ref 'AWS::AccountId' ,':role/role-readwrite-s3-lab-check-s1']]
            Action: 
              - 's3:PutObject'
              - 's3:ListBucket'
              - 's3:GetObject'
              - 's3:DeleteObject'
            Resource:
              - 'arn:aws:s3:::kemper-s3-lab-check-s1'
              - 'arn:aws:s3:::kemper-s3-lab-check-s1/*'
  BucketReadOnlyRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: 'role-readonly-s3-lab-check-s1'
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Federated: !Join
                - ''
                - - 'arn:aws:iam::'
                  - !Ref 'AWS::AccountId'
                  - :saml-provider/PingOne
            Action:
              - sts:AssumeRoleWithSAML
            Condition:
              StringEquals:
                SAML:aud: https://signin.aws.amazon.com/saml
      Policies:
      - PolicyName: policy-readonly-s3-lab-check-s1
        PolicyDocument:
          Statement:
            - Sid: AllowListBucketAccess
              Effect: Allow
              Action: 
                - 's3:ListBucket'
              Resource: arn:aws:s3:::kemper-s3-lab-check-s1
            - Sid: AllowReadOnlyAccess
              Effect: Allow
              Action: 
                - 's3:GetObject'
              Resource: arn:aws:s3:::kemper-s3-lab-check-s1/*
            - Sid: AllowConsoleAccess
              Effect: Allow
              Action:
                - 's3:GetBucketLocation'
                - 's3:ListAllMyBuckets'
              Resource: '*'
  BucketReadWriteRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: 'role-readwrite-s3-lab-check-s1'
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Federated: !Join
                - ''
                - - 'arn:aws:iam::'
                  - !Ref 'AWS::AccountId'
                  - :saml-provider/PingOne
            Action:
              - sts:AssumeRoleWithSAML
            Condition:
              StringEquals:
                SAML:aud: https://signin.aws.amazon.com/saml
      Policies:
      - PolicyName: policy-readwrite-s3-lab-check-s1
        PolicyDocument:
          Statement:
            - Sid: AllowListBucketAccess
              Effect: Allow
              Action:
                - 's3:ListBucket'
              Resource: arn:aws:s3:::kemper-s3-lab-check-s1
            - Sid: AllowReadWriteAccess
              Effect: Allow
              Action: 
                - 's3:PutObject'
                - 's3:GetObject'
              Resource: arn:aws:s3:::kemper-s3-lab-check-s1/*      
            - Sid: AllowConsoleAccess
              Effect: Allow
              Action:
                - 's3:GetBucketLocation'
                - 's3:ListAllMyBuckets'
              Resource: '*'
Outputs:
  S3BucketArn:
    Value: !GetAtt S3Bucket.Arn
  S3BucketDomainName:
    Value: !GetAtt S3Bucket.DomainName

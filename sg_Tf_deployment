AWSTemplateFormatVersion: 2010-09-09
Description: Kemper Security Group - Policy

Parameters:
  Account:
    Type: String
    Default: svc
  Environment:
    Type: String
    Default: t0
  Application:
    Type: String
    Description: Application-specific tag that will change per team needs
    Default: base

Transform:
  Name: 'AWS::Include'
  Parameters:
    Location: 's3://kemper-svc-prd-jenkins-us-east-1/cloudformation/common/vpc-mapping.yml'

Resources:
  #Security group for app servers
  sgec2app:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Join ["-", [!Ref Account, !Ref Application, !Ref Environment, "ec2", "app"]]
      GroupDescription: !Join ["", ["Rules for ", !Ref Application, " ec2-app"]]
      VpcId: !FindInMap [VPCMap, !Ref Account, vpcid] 
      SecurityGroupIngress:
      - IpProtocol: tcp
        FromPort: 8080
        ToPort: 8080
        CidrIp: 10.0.0.0/8
      - IpProtocol: tcp
        FromPort: 8443
        ToPort: 8443
        CidrIp: 10.0.0.0/8
      Tags:
      - Key: Name
        Value: !Join ["-", [!Ref Account, !Ref Application, !Ref Environment, "ec2", "app"]]
      - Key: Account
        Value: !Ref Account
      - Key: Environment
        Value: !Ref Environment
      - Key: Application
        Value: !Ref Application
  sgec2appDynamicInternal:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref sgec2app
      IpProtocol: tcp
      FromPort: 32768
      ToPort: 65535
      SourceSecurityGroupId: !Ref sgec2app
#REPLACE_RESOURCES



Outputs:
  sgec2appID:
    Value: !Ref sgec2app
    Export:
      Name: !Join ["-", ["sg", !Ref Account, !Ref Application, !Ref Environment, "ec2", "app"]]
#REPLACE_OUTPUTS
